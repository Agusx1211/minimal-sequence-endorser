pragma solidity ^0.8.0;

import "wallet-contracts/contracts/modules/commons/interfaces/IModuleCalls.sol";
import "erc5189-libs/interfaces/IEndorser.sol";
import "erc5189-libs/interfaces/IReceiptProvider.sol";
import { LibString } from "erc5189-libs/LibString.sol";
import "../src/utils/LibBytes2.sol";

import { Test, console } from "forge-std/Test.sol";
import { MiniSequenceEndorser } from "../src/MiniSequenceEndorser.sol";
import { PaymentRouter } from "../src/PaymentRouter.sol";
import { Factory } from "wallet-contracts/contracts/Factory.sol";
import { MainModule } from "wallet-contracts/contracts/modules/MainModule.sol";
import { MainModuleUpgradable } from "wallet-contracts/contracts/modules/MainModuleUpgradable.sol";

contract MiniSequenceEndorserTest is Test {
  using LibBytes2 for *;
  using LibString for *;

  Factory factory;
  MiniSequenceEndorser endorser;
  PaymentRouter router;
  MainModule mainModule;

  constructor () {
    factory = new Factory();
    endorser = new MiniSequenceEndorser(address(this), address(factory));
    router = new PaymentRouter();

    MainModuleUpgradable mainModuleUpgradable = new MainModuleUpgradable();
    mainModule = new MainModule(address(factory), address(mainModuleUpgradable));
  
    address[] memory routers = new address[](1);
    routers[0] = address(router);
    endorser.setTrustedPaymentRouters(routers, true);
  
    address[] memory implementations = new address[](1);
    implementations[0] = address(mainModule);
    endorser.setKnownImplementations(implementations, true);
  }

  function testEndorse() external {
    // Signer address
    uint256 pk = uint256(2);

    // Imagehash of the wallet
    // TODO
    bytes32 imageHash = bytes32(0x1ec2964607a4fe793f7be3fd04026e5f6747781a741fd690c033889d47f30043);

    // Deploy a wallet
    address wallet = factory.deploy(address(mainModule), imageHash);
    
    vm.deal(wallet, 2 ether);

    // Generate a sequence transaction
    IModuleCalls.Transaction[] memory txs = new IModuleCalls.Transaction[](1);
    txs[0] = IModuleCalls.Transaction(
      true, // delegateCall
      true, // revertOnError
      0, // gasLimit
      address(router), // target
      0, // value
      abi.encode(
        1 ether
      ) // data
    );

    uint256 nonce;

    bytes32 digest = keccak256(
      abi.encode(
        nonce,
        txs
      )
    );

    bytes32 subdigest = keccak256(
      abi.encodePacked(
        "\x19\x01",
        block.chainid,
        wallet,
        digest
      )
    );

    (
      uint8 _v,
      bytes32 _r,
      bytes32 _s
    ) = vm.sign(pk, subdigest);

    bytes memory signature = abi.encodePacked(
      hex"0001",     // Threshold
      hex"00000000", // Checkpoint
      hex"00",       // Signature part
      hex"01",       // Weight
      _r,
      _s,
      _v,
      hex"01"        // Signature type
    );

    bytes memory data = abi.encodeWithSelector(
      IModuleCalls.execute.selector,
      txs,
      nonce,
      signature
    );

    IEndorser.Operation memory operation;
    operation.entrypoint = wallet;
    operation.data = data;
    operation.endorserCallData = abi.encode(address(mainModule), imageHash);
    operation.fixedGas = 0;
    operation.gasLimit = 500_000;
    operation.maxFeePerGas = 100 gwei;

    endorser.isOperationReady(operation);
  }

  function testOperationFilterV1() external view {
    // https://polygonscan.com/tx/0x4b1533a69704109206eac693f22806899d8179a4c3054eb9468b05bf82e47fe4
    IEndorser.Operation memory operation;
    operation.entrypoint = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    operation.data = hex"7a9a1628000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e300000000000000000000000000000000000000000000000000000000000006a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000036fb0000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000050461c2926c0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002429561426f29aafd03ccd254b64bfe5ad7338a281fb72b077b4b1b5382c8f1a15f926bf7900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d130b43062d875a4b7af3f8fc036bc6e9d3e1b3e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000026444d466c2000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000030000000000000000000000001366536cfa5eab42fa27d0324805a515ec91bddd000000000000000000000000000000000000000000000000000000000000000200000000000000000000000038ca14fa85cd06886f144599d5e56d10a3e22fc30000000000000000000000000000000000000000000000000000000000000003000000000000000000000000596af90cecdbf9a768886e771178fd5561dd27ab0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000ba790e28188dd48b5c56d78fa6182c468283e5f10000000000000000000000000000000000000000000000000000000000000002000000000000000000000000bc9ef0c13bc1d09a0a15cbe6658470ca09ba4aa20000000000000000000000000000000000000000000000000000000000000002000000000000000000000000d5153282ca03cb9c9b1543173ea339904c9071480000000000000000000000000000000000000000000000000000000000000002000000000000000000000000fc58c4951366620c68abd7e0d136a2c3cb99980e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000113000500037d8fe5514d6c7b8c77bb4f5d71d80c5c0ae7ad73c7c1689fc0433100fb592b4362dffff7626c21a19d266e296fe94d7b24968f0baa25851a6939fcbf8052f4d51c02010238ca14fa85cd06886f144599d5e56d10a3e22fc30203596af90cecdbf9a768886e771178fd5561dd27ab005d00010001717ddedeae4797bc4321ac90bc9994bd4eb3217515b860cacb0196446bb2a54f66ba74d85c3a3a0d21a9033e2c6fd9c01d59b670e9753a14b4c040b9c6bb8ce91b020101c50adeadb7fe15bee45dcb820610cdedcd314eb0030102ba790e28188dd48b5c56d78fa6182c468283e5f10102bc9ef0c13bc1d09a0a15cbe6658470ca09ba4aa20102d5153282ca03cb9c9b1543173ea339904c90714800000000000000000000000000";
    operation.endorserCallData = abi.encode(0x7EFE6cE415956c5f80C6530cC6cc81b4808F6118);

    (address _address, bytes32[][] memory topics) = endorser.operationFilter(operation);

    if (_address != 0x0000000000000000000000000000000000000000) {
      revert("expected no address, got ".c(_address));
    }

    if (topics.length != 0) {
      revert("expected no topics, got ".c(topics.length));
    }
  }

  function testOperationReceiptV1() external view {
    // https://polygonscan.com/tx/0x4b1533a69704109206eac693f22806899d8179a4c3054eb9468b05bf82e47fe4
    IEndorser.Operation memory operation;
    operation.entrypoint = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    operation.data = hex"7a9a1628000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001e300000000000000000000000000000000000000000000000000000000000006a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000036fb0000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000050461c2926c0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000002429561426f29aafd03ccd254b64bfe5ad7338a281fb72b077b4b1b5382c8f1a15f926bf7900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d130b43062d875a4b7af3f8fc036bc6e9d3e1b3e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000026444d466c2000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000030000000000000000000000001366536cfa5eab42fa27d0324805a515ec91bddd000000000000000000000000000000000000000000000000000000000000000200000000000000000000000038ca14fa85cd06886f144599d5e56d10a3e22fc30000000000000000000000000000000000000000000000000000000000000003000000000000000000000000596af90cecdbf9a768886e771178fd5561dd27ab0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000ba790e28188dd48b5c56d78fa6182c468283e5f10000000000000000000000000000000000000000000000000000000000000002000000000000000000000000bc9ef0c13bc1d09a0a15cbe6658470ca09ba4aa20000000000000000000000000000000000000000000000000000000000000002000000000000000000000000d5153282ca03cb9c9b1543173ea339904c9071480000000000000000000000000000000000000000000000000000000000000002000000000000000000000000fc58c4951366620c68abd7e0d136a2c3cb99980e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000113000500037d8fe5514d6c7b8c77bb4f5d71d80c5c0ae7ad73c7c1689fc0433100fb592b4362dffff7626c21a19d266e296fe94d7b24968f0baa25851a6939fcbf8052f4d51c02010238ca14fa85cd06886f144599d5e56d10a3e22fc30203596af90cecdbf9a768886e771178fd5561dd27ab005d00010001717ddedeae4797bc4321ac90bc9994bd4eb3217515b860cacb0196446bb2a54f66ba74d85c3a3a0d21a9033e2c6fd9c01d59b670e9753a14b4c040b9c6bb8ce91b020101c50adeadb7fe15bee45dcb820610cdedcd314eb0030102ba790e28188dd48b5c56d78fa6182c468283e5f10102bc9ef0c13bc1d09a0a15cbe6658470ca09ba4aa20102d5153282ca03cb9c9b1543173ea339904c90714800000000000000000000000000";
    operation.endorserCallData = abi.encode(0x7EFE6cE415956c5f80C6530cC6cc81b4808F6118);

    IReceiptProvider.Log[] memory transactionLogs = new IReceiptProvider.Log[](7);

    transactionLogs[0]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[0].topics = new bytes32[](1);
    transactionLogs[0].topics[0] = 0x1f180c27086c7a39ea2a7b25239d1ab92348f07ca7bb59d1438fcf527568f881;
    transactionLogs[0].data = hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e4";

    transactionLogs[1]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[1].topics = new bytes32[](1);
    transactionLogs[1].topics[0] = 0x307ed6bd941ee9fc80f369c94af5fa11e25bab5102a6140191756c5474a30bfa;
    transactionLogs[1].data = hex"f29aafd03ccd254b64bfe5ad7338a281fb72b077b4b1b5382c8f1a15f926bf79";

    transactionLogs[2]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[2].topics = new bytes32[](0);
    transactionLogs[2].data = hex"6364bc56f748da34c6edaf42cd73354ee3718e6e4096befad58ee51de951d560";

    transactionLogs[3]._address = 0xd130B43062D875a4B7aF3f8fc036Bc6e9D3E1B3E;
    transactionLogs[3].topics = new bytes32[](3);
    transactionLogs[3].topics[0] = 0xb502b7446ca079086188acf3abef47c2f464f2ee9a72fcdf05ffcb74dcc17cee;
    transactionLogs[3].topics[1] = 0x000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04;
    transactionLogs[3].topics[2] = 0xf29aafd03ccd254b64bfe5ad7338a281fb72b077b4b1b5382c8f1a15f926bf79;
    transactionLogs[3].data = hex"0000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000030000000000000000000000001366536cfa5eab42fa27d0324805a515ec91bddd000000000000000000000000000000000000000000000000000000000000000200000000000000000000000038ca14fa85cd06886f144599d5e56d10a3e22fc30000000000000000000000000000000000000000000000000000000000000003000000000000000000000000596af90cecdbf9a768886e771178fd5561dd27ab0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000ba790e28188dd48b5c56d78fa6182c468283e5f10000000000000000000000000000000000000000000000000000000000000002000000000000000000000000bc9ef0c13bc1d09a0a15cbe6658470ca09ba4aa20000000000000000000000000000000000000000000000000000000000000002000000000000000000000000d5153282ca03cb9c9b1543173ea339904c9071480000000000000000000000000000000000000000000000000000000000000002000000000000000000000000fc58c4951366620c68abd7e0d136a2c3cb99980e";

    transactionLogs[4]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[4].topics = new bytes32[](0);
    transactionLogs[4].data = hex"6364bc56f748da34c6edaf42cd73354ee3718e6e4096befad58ee51de951d560";

    transactionLogs[5]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[5].topics = new bytes32[](0);
    transactionLogs[5].data = hex"7b0655f37b3287142bd691d1373ad20de10d0d33e3760c8872b3b67929f6176d";

    transactionLogs[6]._address = 0x0000000000000000000000000000000000001010;
    transactionLogs[6].topics = new bytes32[](4);
    transactionLogs[6].topics[0] = 0x4dfe1bbbcf077ddc3e01291eea2d5c70c2b422b415d95645b9adcfd678cb1d63;
    transactionLogs[6].topics[1] = 0x0000000000000000000000000000000000000000000000000000000000001010;
    transactionLogs[6].topics[2] = 0x0000000000000000000000009f8fbc1fe0299f731c930e7128d9a1d4d75ad3bd;
    transactionLogs[6].topics[3] = 0x0000000000000000000000004f856f79f54592a48c8a1a1fafa1b0a3ac053f99;
    transactionLogs[6].data = hex"000000000000000000000000000000000000000000000000002e47ec7f29f40000000000000000000000000000000000000000000000000006f05b59d3b200000000000000000000000000000000000000000000000009d9dd16962bb416a26000000000000000000000000000000000000000000000000006c2136d54880c000000000000000000000000000000000000000000000009d9dd44de1833409660";

    (IReceiptProvider.Status status, IReceiptProvider.Log[] memory operationLogs, uint256 gasUsed) = endorser.operationReceipt(operation, transactionLogs);

    if (status != IReceiptProvider.Status.Succeeded) {
      revert("expected success, got ".c(uint256(status)));
    }

    if (operationLogs.length != 6) {
      revert("expected six operation logs, got ".c(operationLogs.length));
    }

    uint256 first = 0;

    for (uint256 i = 0; i < operationLogs.length; i++) {
      if (operationLogs[i]._address != transactionLogs[first + i]._address) {
        revert("expected log address to match");
      }

      if (operationLogs[i].topics.length != transactionLogs[first + i].topics.length) {
        revert("expected log topics to match");
      }

      for (uint256 j = 0; j < operationLogs[i].topics.length; j++) {
        if (operationLogs[i].topics[j] != transactionLogs[first + i].topics[j]) {
          revert("expected log topic to match");
        }
      }

      if (!operationLogs[i].data.eq(transactionLogs[first + i].data)) {
        revert("expected log data to match");
      }
    }

    if (gasUsed != 0) {
      revert("expected no gas usage, got ".c(gasUsed));
    }
  }

  function testOperationFilterV2() external view {
    // https://polygonscan.com/tx/0x41111c8716c7250d14ce7bcd6c49ecf21399ddc7f4283715518d5c6db8bed589
    IEndorser.Operation memory operation;
    operation.entrypoint = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    operation.data = hex"7a9a1628000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000009f700000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000093120000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000345458cfd2f0c808455342cd0a6e07a09f8932920000000000000000000000000000000000000000000000000000000000002710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007e08701cc9194ef4ffd82421dd0d986d1b43d52100000000000000000000000000000000000000000000000000000000000016c40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001170005000001c401031366536cfa5eab42fa27d0324805a515ec91bddd0400007b0203761f5e29944d79d76656323f106cf2efbf5f09e9000062010001000000000001781e0c6a3a6e9685e9fee608259885c2fc5ec9470145b8b301353ba724a603676baa76efa6768e832c6cfc3a12513755d2aa62f8f24c1871872d6f0517536f281c02010190d62a32d1cc65aa3e80b567c8c0d3ca0f411e6103040000440002c8b36f19fd2c0c8f7c45806932a14dd9096321646214a87e1f7ed408c0b56601212bfc92e4742802b3b086a4ee81dad5fafb0abd15632fdf3a2e78d7094235481b02040000160102144edd96ad864aca244b88d7ae3419ea7ebe24bc040000160102062466fb84c7313018ec8740eaefa3800b93a3bf000000000000000000";
    operation.endorserCallData = abi.encode(0x4222dcA3974E39A8b41c411FeDDE9b09Ae14b911);

    (address _address, bytes32[][] memory topics) = endorser.operationFilter(operation);

    if (_address != 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04) {
      revert("expected address 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04, got ".c(_address));
    }

    if (topics.length != 2) {
      revert("expected two topics, got ".c(topics.length));
    }

    if (topics[0].length != 2) {
      revert("expected two options for first topic, got ".c(topics[0].length));
    }

    if (topics[0][0] != 0x5c4eeb02dabf8976016ab414d617f9a162936dcace3cdef8c69ef6e262ad5ae7) {
      revert("expected TxExecuted as option for first topic, got ".c(topics[0][0]));
    }

    if (topics[0][1] != 0xab46c69f7f32e1bf09b0725853da82a211e5402a0600296ab499a2fb5ea3b419) {
      revert("expected TxFailed as option for first topic, got ".c(topics[0][1]));
    }

    if (topics[1].length != 1) {
      revert("expected one option for second topic, got ".c(topics[1].length));
    }

    if (topics[1][0] != 0x9ed6e84956b40fcf4884887abb0a374227ce4c98d25d8df08982aa65fa48b748) {
      revert("expected subdigest as option for second topic, got ".c(topics[1][0]));
    }
  }

  function testOperationReceiptV2() external view {
    // https://polygonscan.com/tx/0x41111c8716c7250d14ce7bcd6c49ecf21399ddc7f4283715518d5c6db8bed589
    IEndorser.Operation memory operation;
    operation.entrypoint = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    operation.data = hex"7a9a1628000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000009f700000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000093120000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000345458cfd2f0c808455342cd0a6e07a09f8932920000000000000000000000000000000000000000000000000000000000002710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000186a00000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa84174000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007e08701cc9194ef4ffd82421dd0d986d1b43d52100000000000000000000000000000000000000000000000000000000000016c40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001170005000001c401031366536cfa5eab42fa27d0324805a515ec91bddd0400007b0203761f5e29944d79d76656323f106cf2efbf5f09e9000062010001000000000001781e0c6a3a6e9685e9fee608259885c2fc5ec9470145b8b301353ba724a603676baa76efa6768e832c6cfc3a12513755d2aa62f8f24c1871872d6f0517536f281c02010190d62a32d1cc65aa3e80b567c8c0d3ca0f411e6103040000440002c8b36f19fd2c0c8f7c45806932a14dd9096321646214a87e1f7ed408c0b56601212bfc92e4742802b3b086a4ee81dad5fafb0abd15632fdf3a2e78d7094235481b02040000160102144edd96ad864aca244b88d7ae3419ea7ebe24bc040000160102062466fb84c7313018ec8740eaefa3800b93a3bf000000000000000000";
    operation.endorserCallData = abi.encode(0x4222dcA3974E39A8b41c411FeDDE9b09Ae14b911);

    IReceiptProvider.Log[] memory transactionLogs = new IReceiptProvider.Log[](6);

    transactionLogs[0]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[0].topics = new bytes32[](1);
    transactionLogs[0].topics[0] = 0x1f180c27086c7a39ea2a7b25239d1ab92348f07ca7bb59d1438fcf527568f881;
    transactionLogs[0].data = hex"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009f8";

    transactionLogs[1]._address = 0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174;
    transactionLogs[1].topics = new bytes32[](3);
    transactionLogs[1].topics[0] = 0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef;
    transactionLogs[1].topics[1] = 0x000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04;
    transactionLogs[1].topics[2] = 0x000000000000000000000000345458cfd2f0c808455342cd0a6e07a09f893292;
    transactionLogs[1].data = hex"0000000000000000000000000000000000000000000000000000000000002710";

    transactionLogs[2]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[2].topics = new bytes32[](2);
    transactionLogs[2].topics[0] = 0x5c4eeb02dabf8976016ab414d617f9a162936dcace3cdef8c69ef6e262ad5ae7;
    transactionLogs[2].topics[1] = 0x9ed6e84956b40fcf4884887abb0a374227ce4c98d25d8df08982aa65fa48b748;
    transactionLogs[2].data = hex"0000000000000000000000000000000000000000000000000000000000000000";

    transactionLogs[3]._address = 0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174;
    transactionLogs[3].topics = new bytes32[](3);
    transactionLogs[3].topics[0] = 0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef;
    transactionLogs[3].topics[1] = 0x000000000000000000000000468e8e29f6cfb0f6b7ff10ec6a1ab516ec849c04;
    transactionLogs[3].topics[2] = 0x0000000000000000000000007e08701cc9194ef4ffd82421dd0d986d1b43d521;
    transactionLogs[3].data = hex"00000000000000000000000000000000000000000000000000000000000016c4";

    transactionLogs[4]._address = 0x468E8e29F6cfb0F6b7ff10ec6A1AB516ec849c04;
    transactionLogs[4].topics = new bytes32[](2);
    transactionLogs[4].topics[0] = 0x5c4eeb02dabf8976016ab414d617f9a162936dcace3cdef8c69ef6e262ad5ae7;
    transactionLogs[4].topics[1] = 0x9ed6e84956b40fcf4884887abb0a374227ce4c98d25d8df08982aa65fa48b748;
    transactionLogs[4].data = hex"0000000000000000000000000000000000000000000000000000000000000001";

    transactionLogs[5]._address = 0x0000000000000000000000000000000000001010;
    transactionLogs[5].topics = new bytes32[](4);
    transactionLogs[5].topics[0] = 0x4dfe1bbbcf077ddc3e01291eea2d5c70c2b422b415d95645b9adcfd678cb1d63;
    transactionLogs[5].topics[1] = 0x0000000000000000000000000000000000000000000000000000000000001010;
    transactionLogs[5].topics[2] = 0x00000000000000000000000052fba7915b2b37f85100b543af54fba499228846;
    transactionLogs[5].topics[3] = 0x0000000000000000000000007c7379531b2aee82e4ca06d4175d13b9cbeafd49;
    transactionLogs[5].data = hex"0000000000000000000000000000000000000000000000000010a79beb534bdf000000000000000000000000000000000000000000000000a1db95ccb43c3a1e00000000000000000000000000000000000000000002dd8a748b7ea574cbc5c3000000000000000000000000000000000000000000000000a1caee30c8e8ee3f00000000000000000000000000000000000000000002dd8a749c2641601f11a2";

    (IReceiptProvider.Status status, IReceiptProvider.Log[] memory operationLogs, uint256 gasUsed) = endorser.operationReceipt(operation, transactionLogs);

    if (status != IReceiptProvider.Status.Succeeded) {
      revert("expected success, got ".c(uint256(status)));
    }

    if (operationLogs.length != 5) {
      revert("expected five operation logs, got ".c(operationLogs.length));
    }

    uint256 first = 0;

    for (uint256 i = 0; i < operationLogs.length; i++) {
      if (operationLogs[i]._address != transactionLogs[first + i]._address) {
        revert("expected log address to match");
      }

      if (operationLogs[i].topics.length != transactionLogs[first + i].topics.length) {
        revert("expected log topics to match");
      }

      for (uint256 j = 0; j < operationLogs[i].topics.length; j++) {
        if (operationLogs[i].topics[j] != transactionLogs[first + i].topics[j]) {
          revert("expected log topic to match");
        }
      }

      if (!operationLogs[i].data.eq(transactionLogs[first + i].data)) {
        revert("expected log data to match");
      }
    }

    if (gasUsed != 0) {
      revert("expected no gas usage, got ".c(gasUsed));
    }
  }
}
